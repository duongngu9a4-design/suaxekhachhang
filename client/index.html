<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trang Chủ - Sửa Xe Khách Hàng</title>
  <link rel="shortcut icon" href="./src/img/logo.png" type="image/x-icon" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="./src/css/main.css" />
</head>

<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><i class="fa-solid fa-screwdriver-wrench"></i> Sửa Xe Khách Hàng</a>
      <div class="d-flex">
        <span class="text-white me-3" id="user-info"><i class="fa-solid fa-user"></i> Khách</span>
        <button class="btn btn-outline-light btn-sm" id="logout-btn">Đăng xuất</button>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <ul class="nav nav-tabs">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#car">Thông tin xe</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#maintenance">Lịch sử bảo dưỡng</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#expense">Chi phí bảo dưỡng</button></li>
    </ul>

    <div class="tab-content mt-3">
      <!-- ================== THÔNG TIN XE ================== -->
      <div class="tab-pane fade show active" id="car">
        <h5>Thêm thông tin xe</h5>
        <form id="add-car-form" class="row g-3 mb-3">
          <div class="col-md-3"><input name="plate" type="text" class="form-control" placeholder="Biển số" required></div>
          <div class="col-md-3"><input name="brand" type="text" class="form-control" placeholder="Hãng" required></div>
          <div class="col-md-3"><input name="model" type="text" class="form-control" placeholder="Model" required></div>
          <div class="col-md-3"><input name="year" type="number" class="form-control" placeholder="Năm sản xuất" required></div>
          <div class="col-12"><button class="btn btn-primary">Thêm xe</button></div>
        </form>

        <h5>Danh sách xe</h5>
        <table class="table table-striped align-middle">
          <thead><tr><th>Biển số</th><th>Hãng</th><th>Model</th><th>Năm</th><th>Hành động</th></tr></thead>
          <tbody id="car-list"></tbody>
        </table>
      </div>

      <!-- ================== BẢO DƯỠNG ================== -->
      <div class="tab-pane fade" id="maintenance">
        <h5>Ghi lịch sử bảo dưỡng</h5>
        <form id="maintenance-form" class="row g-3 mb-3">
          <div class="col-md-3"><input name="plate" type="text" class="form-control" placeholder="Biển số" required></div>
          <div class="col-md-5"><input name="content" type="text" class="form-control" placeholder="Nội dung bảo dưỡng" required></div>
          <div class="col-md-4"><input name="date" type="date" class="form-control" required></div>
          <div class="col-12"><button class="btn btn-success">Lưu lịch sử</button></div>
        </form>
        <h5>Lịch sử bảo dưỡng</h5>
        <table class="table table-bordered align-middle">
          <thead><tr><th>Biển số</th><th>Nội dung</th><th>Ngày</th><th>Hành động</th></tr></thead>
          <tbody id="maintenance-history"></tbody>
        </table>
      </div>

      <!-- ================== CHI PHÍ ================== -->
      <div class="tab-pane fade" id="expense">
        <h5>Ghi chi phí bảo dưỡng</h5>
        <form id="expense-form" class="row g-3 mb-3">
          <div class="col-md-4"><input name="plate" type="text" class="form-control" placeholder="Biển số" required></div>
          <div class="col-md-4"><input name="amount" type="number" class="form-control" placeholder="Số tiền (VNĐ)" required></div>
          <div class="col-md-4"><input name="date" type="date" class="form-control" required></div>
          <div class="col-12"><button class="btn btn-warning">Lưu chi phí</button></div>
        </form>
        <h5>Thống kê chi phí</h5>
        <canvas id="expenseChart" height="100"></canvas>
        <table class="table mt-3 align-middle">
          <thead><tr><th>Biển số</th><th>Số tiền</th><th>Ngày</th><th>Hành động</th></tr></thead>
          <tbody id="expense-list"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import { auth, db } from "./src/js/firebase-config.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { collection, addDoc, getDocs, query, where, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const logoutBtn = document.getElementById("logout-btn");
    const userInfo = document.getElementById("user-info");

    logoutBtn.onclick = async () => { await signOut(auth); window.location.href = "login.html"; };

    onAuthStateChanged(auth, (user) => {
      if (!user) return (window.location.href = "login.html");
      userInfo.innerHTML = `<i class="fa-solid fa-user"></i> ${user.email}`;
      initApp(user.uid);
    });

    function initApp(uid) {
      // ===================== CAR =====================
      const carForm = document.getElementById("add-car-form");
      const carList = document.getElementById("car-list");
      const carCollection = collection(db, "cars");
      let editingCarId = null;

      carForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = {
          uid, plate: carForm.plate.value, brand: carForm.brand.value,
          model: carForm.model.value, year: carForm.year.value
        };
        if (editingCarId) {
          await updateDoc(doc(db, "cars", editingCarId), data);
          editingCarId = null;
          carForm.querySelector("button").textContent = "Thêm xe";
        } else await addDoc(carCollection, data);
        carForm.reset(); loadCars();
      });

      async function loadCars() {
        carList.innerHTML = "";
        const q = query(carCollection, where("uid", "==", uid));
        const snapshot = await getDocs(q);
        snapshot.forEach((d) => {
          const c = d.data();
          carList.innerHTML += `
            <tr>
              <td>${c.plate}</td><td>${c.brand}</td><td>${c.model}</td><td>${c.year}</td>
              <td>
                <button class="btn btn-sm btn-info text-white" onclick="editCar('${d.id}','${c.plate}','${c.brand}','${c.model}','${c.year}')">Sửa</button>
                <button class="btn btn-sm btn-danger" onclick="deleteCar('${d.id}')">Xóa</button>
              </td>
            </tr>`;
        });
      }
      window.deleteCar = async (id) => { await deleteDoc(doc(db, "cars", id)); loadCars(); };
      window.editCar = (id, p, b, m, y) => {
        carForm.plate.value = p; carForm.brand.value = b; carForm.model.value = m; carForm.year.value = y;
        editingCarId = id; carForm.querySelector("button").textContent = "Cập nhật xe";
      };
      loadCars();

      // ===================== MAINTENANCE =====================
      const maintForm = document.getElementById("maintenance-form");
      const maintList = document.getElementById("maintenance-history");
      const maintCollection = collection(db, "maintenance");
      let editingMaintId = null;

      maintForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = {
          uid, plate: maintForm.plate.value, content: maintForm.content.value, date: maintForm.date.value
        };
        if (editingMaintId) {
          await updateDoc(doc(db, "maintenance", editingMaintId), data);
          editingMaintId = null;
          maintForm.querySelector("button").textContent = "Lưu lịch sử";
        } else await addDoc(maintCollection, data);
        maintForm.reset(); loadMaint();
      });

      async function loadMaint() {
        maintList.innerHTML = "";
        const q = query(maintCollection, where("uid", "==", uid));
        const snapshot = await getDocs(q);
        snapshot.forEach((d) => {
          const m = d.data();
          maintList.innerHTML += `
            <tr>
              <td>${m.plate}</td><td>${m.content}</td><td>${m.date}</td>
              <td>
                <button class="btn btn-sm btn-info text-white" onclick="editMaint('${d.id}','${m.plate}','${m.content}','${m.date}')">Sửa</button>
                <button class="btn btn-sm btn-danger" onclick="deleteMaint('${d.id}')">Xóa</button>
              </td>
            </tr>`;
        });
      }

      window.deleteMaint = async (id) => { await deleteDoc(doc(db, "maintenance", id)); loadMaint(); };
      window.editMaint = (id, p, c, dte) => {
        maintForm.plate.value = p; maintForm.content.value = c; maintForm.date.value = dte;
        editingMaintId = id; maintForm.querySelector("button").textContent = "Cập nhật lịch sử";
      };
      loadMaint();

      // ===================== EXPENSE =====================
      const expForm = document.getElementById("expense-form");
      const expList = document.getElementById("expense-list");
      const expCollection = collection(db, "expenses");
      let editingExpId = null; let chart;

      expForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = { uid, plate: expForm.plate.value, amount: +expForm.amount.value, date: expForm.date.value };
        if (editingExpId) {
          await updateDoc(doc(db, "expenses", editingExpId), data);
          editingExpId = null;
          expForm.querySelector("button").textContent = "Lưu chi phí";
        } else await addDoc(expCollection, data);
        expForm.reset(); loadExpense();
      });

      async function loadExpense() {
        expList.innerHTML = "";
        const q = query(expCollection, where("uid", "==", uid));
        const snapshot = await getDocs(q);
        const labels = [], data = [];
        snapshot.forEach((d) => {
          const e = d.data();
          expList.innerHTML += `
            <tr>
              <td>${e.plate}</td><td>${e.amount}</td><td>${e.date}</td>
              <td>
                <button class="btn btn-sm btn-info text-white" onclick="editExp('${d.id}','${e.plate}','${e.amount}','${e.date}')">Sửa</button>
                <button class="btn btn-sm btn-danger" onclick="deleteExp('${d.id}')">Xóa</button>
              </td>
            </tr>`;
          labels.push(e.date); data.push(e.amount);
        });

        if (chart) chart.destroy();
        chart = new Chart(document.getElementById("expenseChart"), {
          type: "bar",
          data: { labels, datasets: [{ label: "Chi phí (VNĐ)", data }] },
        });
      }

      window.deleteExp = async (id) => { await deleteDoc(doc(db, "expenses", id)); loadExpense(); };
      window.editExp = (id, p, a, dte) => {
        expForm.plate.value = p; expForm.amount.value = a; expForm.date.value = dte;
        editingExpId = id; expForm.querySelector("button").textContent = "Cập nhật chi phí";
      };
      loadExpense();
    }
  </script>
</body>
</html>


