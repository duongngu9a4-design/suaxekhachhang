<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trang Chủ - Sửa Xe Khách Hàng</title>
<link rel="shortcut icon" href="./src/img/logo.png" type="image/x-icon">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<style>
body {
  font-family: "Arial", "DejaVu Sans", sans-serif;
  background-color: #f8f9fa;
}
/* Toast container */
.toast-container {
  position: fixed;
  top: 1rem;
  right: 1rem;
  z-index: 2100;
}
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#"><i class="fa-solid fa-screwdriver-wrench"></i> Sửa Xe Khách Hàng</a>
    <div class="d-flex">
      <span class="text-white me-3" id="user-info"><i class="fa-solid fa-user"></i> Khách</span>
      <button class="btn btn-outline-light btn-sm" id="logout-btn">Đăng xuất</button>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <ul class="nav nav-tabs">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#car">Thông tin xe</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#maintenance">Lịch sử bảo dưỡng</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#expense">Chi phí bảo dưỡng</button></li>
  </ul>

  <div class="tab-content mt-3">
    <!-- Thông tin xe -->
    <div class="tab-pane fade show active" id="car">
      <h5>Thêm/Sửa thông tin xe</h5>
      <form id="add-car-form" class="row g-3 mb-3">
        <div class="col-md-3"><input name="plate" type="text" class="form-control" placeholder="Biển số" required></div>
        <div class="col-md-3"><input name="brand" type="text" class="form-control" placeholder="Hãng" required></div>
        <div class="col-md-3"><input name="model" type="text" class="form-control" placeholder="Model" required></div>
        <div class="col-md-3"><input name="year" type="number" class="form-control" placeholder="Năm sản xuất" required></div>
        <div class="col-12"><button class="btn btn-primary">Thêm xe</button></div>
      </form>
      <h5>Danh sách xe</h5>
      <table class="table table-striped align-middle" id="car-list">
        <thead><tr><th>Biển số</th><th>Hãng</th><th>Model</th><th>Năm</th><th>Hành động</th></tr></thead>
        <tbody id="car-list-body"></tbody>
      </table>
    </div>

    <!-- Lịch sử bảo dưỡng -->
    <div class="tab-pane fade" id="maintenance">
      <h5>Ghi/Sửa lịch sử bảo dưỡng</h5>
      <form id="maintenance-form" class="row g-3 mb-3">
        <div class="col-md-3"><input name="plate" type="text" class="form-control" placeholder="Biển số" required></div>
        <div class="col-md-5"><input name="content" type="text" class="form-control" placeholder="Nội dung bảo dưỡng" required></div>
        <div class="col-md-4"><input name="date" type="date" class="form-control" required></div>
        <div class="col-12"><button class="btn btn-success">Lưu lịch sử</button></div>
      </form>
      <h5>Lịch sử bảo dưỡng</h5>
      <table class="table table-bordered align-middle" id="maintenance-list">
        <thead><tr><th>Biển số</th><th>Nội dung</th><th>Ngày</th><th>Hành động</th></tr></thead>
        <tbody id="maintenance-list-body"></tbody>
      </table>
    </div>

    <!-- Chi phí -->
    <div class="tab-pane fade" id="expense">
      <h5>Ghi/Sửa chi phí bảo dưỡng</h5>
      <form id="expense-form" class="row g-3 mb-3">
        <div class="col-md-4"><input name="plate" type="text" class="form-control" placeholder="Biển số" required></div>
        <div class="col-md-4"><input name="amount" type="number" class="form-control" placeholder="Số tiền (VNĐ)" required></div>
        <div class="col-md-4"><input name="date" type="date" class="form-control" required></div>
        <div class="col-12"><button class="btn btn-warning">Lưu chi phí</button></div>
      </form>
      <h5>Thống kê chi phí</h5>
      <canvas id="expenseChart" height="100"></canvas>
      <table class="table mt-3 align-middle" id="expense-list">
        <thead><tr><th>Biển số</th><th>Số tiền</th><th>Ngày</th><th>Hành động</th></tr></thead>
        <tbody id="expense-list-body"></tbody>
      </table>
    </div>

    <button class="btn btn-secondary mt-3" id="export-pdf-btn">Xuất PDF toàn bộ</button>
  </div>
</div>

<!-- Modal cảnh báo bảo dưỡng -->
<div class="modal fade" id="maintenanceAlertModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">Thông báo bảo dưỡng</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="maintenanceAlertBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast container + Confirm modal -->
<div class="toast-container" id="toastContainer"></div>
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-warning">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">Xác nhận xóa</h5>
      </div>
      <div class="modal-body" id="confirmDeleteBody">Bạn có chắc là muốn xóa? (Việc xóa sẽ xóa hết 1 bản ghi)</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="confirmDeleteCancel" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteOk">Xóa</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { auth, db } from "./src/js/firebase-config.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { collection, addDoc, getDocs, query, where, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const logoutBtn = document.getElementById("logout-btn");
const userInfo = document.getElementById("user-info");

// ========= HÀM HỖ TRỢ TOAST =========
function showToast(message, type = "info") {
  const colorClass = { success: "bg-success text-white", danger: "bg-danger text-white", warning: "bg-warning", info: "bg-primary text-white" }[type] || "bg-primary text-white";
  const container = document.getElementById("toastContainer");
  const toast = document.createElement("div");
  toast.className = `toast align-items-center ${colorClass} border-0 d-flex mb-2`;
  toast.role = "alert";
  toast.setAttribute("aria-live", "assertive");
  toast.setAttribute("aria-atomic", "true");
  toast.style.minWidth = "200px";
  toast.innerHTML = `<div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>`;
  container.appendChild(toast);
  const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
  bsToast.show();
  toast.addEventListener("hidden.bs.toast", () => toast.remove());
}

// ========= HÀM XÁC NHẬN =========
function showConfirmDelete(message) {
  return new Promise((resolve) => {
    const modalEl = document.getElementById("confirmDeleteModal");
    const modalBody = document.getElementById("confirmDeleteBody");
    const okBtn = document.getElementById("confirmDeleteOk");
    const cancelBtn = document.getElementById("confirmDeleteCancel");
    modalBody.innerHTML = message;
    const modal = new bootstrap.Modal(modalEl);

    const cleanup = () => { okBtn.removeEventListener("click", onOk); cancelBtn.removeEventListener("click", onCancel); };
    const onOk = () => { cleanup(); modal.hide(); resolve(true); };
    const onCancel = () => { cleanup(); modal.hide(); resolve(false); };

    okBtn.addEventListener("click", onOk);
    cancelBtn.addEventListener("click", onCancel);

    modal.show();
  });
}

logoutBtn.onclick = async () => {
  console.log("Đang đăng xuất...");
  await signOut(auth);
  showToast("Đăng xuất thành công", "info");
  window.location.href = "login.html";
};

onAuthStateChanged(auth, user => {
  if (!user) return window.location.href = "login.html";
  userInfo.innerHTML = `<i class="fa-solid fa-user"></i> ${user.email}`;
  initApp(user.uid);
});

function initApp(uid){
  const { jsPDF } = window.jspdf;

  // ================= XE =================
  const carForm = document.getElementById("add-car-form");
  const carBody = document.getElementById("car-list-body");
  const carCollection = collection(db,"cars");
  let editingCarId = null;

  carForm.addEventListener("submit", async e=>{
    e.preventDefault();
    // Kiểm tra trùng biển số (so sánh không phân biệt hoa thường, bớt khoảng trắng)
    const plateRaw = carForm.plate.value || "";
    const plate = plateRaw.trim().toUpperCase();
    const brand = carForm.brand.value;
    const model = carForm.model.value;
    const year = carForm.year.value;

    if (!plate) { showToast("Vui lòng nhập biển số", "warning"); return; }

    if(editingCarId){
      // khi cập nhật: nếu đổi biển số, vẫn nên kiểm tra trùng (với các bản ghi khác)
      const existingSnap = await getDocs(query(carCollection, where("uid","==",uid), where("plate","==",plate)));
      // nếu tìm thấy bản ghi khác (id khác editingCarId) -> báo trùng
      let duplicate = false;
      existingSnap.forEach(d => { if(d.id !== editingCarId) duplicate = true; });
      if(duplicate){
        showToast("Xe đã tồn tại với biển số này!", "warning");
        return;
      }
      const data={uid, plate, brand, model, year};
      await updateDoc(doc(db,"cars",editingCarId), data);
      editingCarId=null;
      carForm.querySelector("button").textContent="Thêm xe";
      showToast("Cập nhật xe thành công!", "success");
    } else {
      // thêm mới: kiểm tra trùng hoàn toàn
      const existing = await getDocs(query(carCollection, where("uid","==",uid), where("plate","==",plate)));
      if(!existing.empty){
        showToast("Xe đã tồn tại với biển số này!", "warning");
        return;
      }
      const data={uid, plate, brand, model, year};
      await addDoc(carCollection,data);
      showToast("Thêm xe thành công!", "success");
    }
    carForm.reset();
    loadCars();
  });

  async function loadCars(){
    carBody.innerHTML="";
    const snap = await getDocs(query(carCollection, where("uid","==",uid)));
    snap.forEach(d=>{
      const c=d.data();
      // escape single quotes in plate/brand/model to avoid breaking onclick string
      const escPlate = (c.plate + "").replace(/'/g, "\\'");
      const escBrand = (c.brand + "").replace(/'/g, "\\'");
      const escModel = (c.model + "").replace(/'/g, "\\'");
      const escYear = (c.year + "").replace(/'/g, "\\'");
      carBody.innerHTML += `<tr>
        <td>${c.plate}</td><td>${c.brand}</td><td>${c.model}</td><td>${c.year}</td>
        <td>
          <button class="btn btn-sm btn-info text-white" onclick="editCar('${d.id}','${escPlate}','${escBrand}','${escModel}','${escYear}')">Sửa</button>
          <button class="btn btn-sm btn-danger" onclick="deleteCar('${d.id}','${escPlate}')">Xóa</button>
        </td>
      </tr>`;
    });
  }

  // expose editCar and deleteCar to global so the inline onclick works (module scope)
  window.editCar=(id,p,b,m,y)=>{
    carForm.plate.value=p;
    carForm.brand.value=b;
    carForm.model.value=m;
    carForm.year.value=y;
    editingCarId=id;
    carForm.querySelector("button").textContent="Cập nhật xe";
  }

  // now deleteCar will show confirm and also delete related maintenance & expenses
  window.deleteCar=async (id, plate) => {
    const message = `⚠️ Việc xóa xe ${plate} sẽ xóa toàn bộ bản ghi.\nBạn có chắc chắn muốn xóa?`;
    const ok = await showConfirmDelete(message);
    if(!ok) return;
    try{
      await deleteDoc(doc(db,"cars",id));
      // xóa bảo dưỡng liên quan
      const maintCollection = collection(db,"maintenance");
      const maintSnap = await getDocs(query(maintCollection, where("plate","==",plate)));
      maintSnap.forEach(async d => { await deleteDoc(doc(db,"maintenance",d.id)); });
      // xóa chi phí liên quan
      const expCollection = collection(db,"expenses");
      const expSnap = await getDocs(query(expCollection, where("plate","==",plate)));
      expSnap.forEach(async d => { await deleteDoc(doc(db,"expenses",d.id)); });

      showToast("Đã xóa xe và các bản ghi liên quan!", "danger");
      loadCars();
      loadMaint();
      loadExpense();
    } catch(err){
      console.error(err);
      showToast("Lỗi khi xóa xe!", "danger");
    }
  }
  loadCars();

  // ================= BẢO DƯỠNG =================
  const maintForm=document.getElementById("maintenance-form");
  const maintBody=document.getElementById("maintenance-list-body");
  const maintCollection=collection(db,"maintenance");
  let editingMaintId=null;

  maintForm.addEventListener("submit", async e=>{
    e.preventDefault();

    const plateRaw = maintForm.plate.value || "";
    const plate = plateRaw.trim().toUpperCase();
    const content = maintForm.content.value || "";
    const date = maintForm.date.value || "";

    if(!plate || !content || !date){
      showToast("Vui lòng điền đầy đủ thông tin bảo dưỡng!", "warning");
      return;
    }

    // kiểm tra xem xe đã tồn tại trong collection cars chưa
    const carSnap = await getDocs(query(carCollection, where("uid","==",uid), where("plate","==",plate)));
    if(carSnap.empty){
      showToast(`❌ Xe với biển số ${plate} chưa tồn tại! Vui lòng thêm xe trước khi ghi lịch sử.`, "danger");
      return;
    }

    const data={uid, plate, content, date};
    if(editingMaintId){
      await updateDoc(doc(db,"maintenance",editingMaintId), data);
      editingMaintId=null;
      maintForm.querySelector("button").textContent="Lưu lịch sử";
      showToast("Cập nhật lịch sử bảo dưỡng thành công!", "success");
    }
    else {
      await addDoc(maintCollection,data);
      showToast("Thêm lịch sử bảo dưỡng thành công!", "success");
    }
    maintForm.reset(); loadMaint();
  });

  async function loadMaint(){
    maintBody.innerHTML="";
    const snap=await getDocs(query(maintCollection, where("uid","==",uid)));
    const dueCars=[];
    snap.forEach(d=>{
      const m=d.data();
      const escPlate = (m.plate + "").replace(/'/g, "\\'");
      const escContent = (m.content + "").replace(/'/g, "\\'");
      maintBody.innerHTML += `<tr>
        <td>${m.plate}</td><td>${m.content}</td><td>${m.date}</td>
        <td>
          <button class="btn btn-sm btn-info text-white" onclick="editMaint('${d.id}','${escPlate}','${escContent}','${m.date}')">Sửa</button>
          <button class="btn btn-sm btn-danger" onclick="deleteMaint('${d.id}')">Xóa</button>
        </td>
      </tr>`;
      const diff=(new Date(m.date)-new Date())/(1000*60*60*24);
      if(diff>=0 && diff<=7) dueCars.push(`${m.plate} - ${m.content} - ${m.date}`);
    });
    if(dueCars.length>0){
      document.getElementById("maintenanceAlertBody").innerHTML=`Các xe sắp đến hạn bảo dưỡng:<br>${dueCars.join("<br>")}`;
      new bootstrap.Modal(document.getElementById("maintenanceAlertModal")).show();
    }
  }
  window.editMaint=(id,p,c,dte)=>{ maintForm.plate.value=p; maintForm.content.value=c; maintForm.date.value=dte; editingMaintId=id; maintForm.querySelector("button").textContent="Cập nhật lịch sử"; }
  window.deleteMaint=async id=>{
    const ok = await showConfirmDelete("Bạn có chắc muốn xóa lịch sử bảo dưỡng này? (Không thể hoàn tác)");
    if(!ok) return;
    await deleteDoc(doc(db,"maintenance",id));
    showToast("Xóa lịch sử bảo dưỡng thành công!", "danger");
    loadMaint();
  }
  loadMaint();

  // ================= CHI PHÍ =================
  const expForm=document.getElementById("expense-form");
  const expBody=document.getElementById("expense-list-body");
  const expCollection=collection(db,"expenses");
  let editingExpId=null;
  let chart;

  expForm.addEventListener("submit", async e=>{
    e.preventDefault();

    const plateRaw = expForm.plate.value || "";
    const plate = plateRaw.trim().toUpperCase();
    const amount = +expForm.amount.value;
    const date = expForm.date.value || "";

    if(!plate || !amount || !date){
      showToast("Vui lòng điền đầy đủ thông tin chi phí!", "warning");
      return;
    }

    // kiểm tra xem xe đã tồn tại trong collection cars chưa
    const carSnap = await getDocs(query(carCollection, where("uid","==",uid), where("plate","==",plate)));
    if(carSnap.empty){
      showToast(`❌ Xe với biển số ${plate} chưa tồn tại! Vui lòng thêm xe trước khi ghi chi phí.`, "danger");
      return;
    }

    const data={uid, plate, amount, date};
    if(editingExpId){
      await updateDoc(doc(db,"expenses",editingExpId), data);
      editingExpId=null;
      expForm.querySelector("button").textContent="Lưu chi phí";
      showToast("Cập nhật chi phí thành công!", "success");
    }
    else {
      await addDoc(expCollection,data);
      showToast("Thêm chi phí thành công!", "success");
    }
    expForm.reset(); loadExpense();
  });

  async function loadExpense(){
    expBody.innerHTML="";
    const snap=await getDocs(query(expCollection, where("uid","==",uid)));
    const labels=[], dataSet=[];
    snap.forEach(d=>{
      const e=d.data();
      const escPlate = (e.plate + "").replace(/'/g, "\\'");
      expBody.innerHTML += `<tr>
        <td>${e.plate}</td><td>${e.amount}</td><td>${e.date}</td>
        <td>
          <button class="btn btn-sm btn-info text-white" onclick="editExp('${d.id}','${escPlate}','${e.amount}','${e.date}')">Sửa</button>
          <button class="btn btn-sm btn-danger" onclick="deleteExp('${d.id}')">Xóa</button>
        </td>
      </tr>`;
      labels.push(e.date); dataSet.push(e.amount);
    });
    if(chart) chart.destroy();
    chart=new Chart(document.getElementById("expenseChart"), {type:"bar", data:{labels, datasets:[{label:"Chi phí (VNĐ)", data:dataSet, backgroundColor:"#0d6efd"}]}});

  }
  window.editExp=(id,p,a,dte)=>{ expForm.plate.value=p; expForm.amount.value=a; expForm.date.value=dte; editingExpId=id; expForm.querySelector("button").textContent="Cập nhật chi phí"; }
  window.deleteExp=async id=>{
    const ok = await showConfirmDelete("Bạn có chắc muốn xóa chi phí này? (Không thể hoàn tác)");
    if(!ok) return;
    await deleteDoc(doc(db,"expenses",id));
    showToast("Xóa chi phí thành công!", "danger");
    loadExpense();
  }
  loadExpense();

  // ================= XUẤT PDF =================
  document.getElementById("export-pdf-btn").onclick=async ()=>{
    const pdf=new jsPDF("p","mm","a4");
    let y=15;

    // Xe
    const carSnap=await getDocs(query(carCollection, where("uid","==",uid)));
    const carTable=[]; carSnap.forEach(d=>{ const c=d.data(); carTable.push([c.plate,c.brand,c.model,c.year]); });
    pdf.text("Danh sách xe",14,y);
    pdf.autoTable({ head:[["Biển số","Hãng","Model","Năm"]], body:carTable, startY:y+5 });
    y=pdf.lastAutoTable.finalY+10;

    // Bảo dưỡng
    const maintSnap=await getDocs(query(maintCollection, where("uid","==",uid)));
    const maintTable=[]; maintSnap.forEach(d=>{ const m=d.data(); maintTable.push([m.plate,m.content,m.date]); });
    pdf.text("Lịch sử bảo dưỡng",14,y);
    pdf.autoTable({ head:[["Biển số","Nội dung","Ngày"]], body:maintTable, startY:y+5 });
    y=pdf.lastAutoTable.finalY+10;

    // Chi phí
    const expSnap=await getDocs(query(expCollection, where("uid","==",uid)));
    const expTable=[]; expSnap.forEach(d=>{ const e=d.data(); expTable.push([e.plate,e.amount,e.date]); });
    pdf.text("Chi phí bảo dưỡng",14,y);
    pdf.autoTable({ head:[["Biển số","Số tiền","Ngày"]], body:expTable, startY:y+5 });

    // Biểu đồ
    const chartCanvas=document.getElementById("expenseChart");
    if(chartCanvas){
      const imgData=chartCanvas.toDataURL("image/png");
      pdf.addPage();
      pdf.text("Biểu đồ chi phí",14,15);
      pdf.addImage(imgData,"PNG",14,20,180,90);
    }

    pdf.save("BaoDuongXe.pdf");
    showToast("Xuất PDF thành công!", "success");
  };
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
